<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/xhr-mock/dist/xhr-mock.js"></script>
</head>

<body>

    <textarea id="output" rows="10" cols="66" style="width: 90vw; height: 90vh; padding-top: 0; margin-top: 0;" READONLY></textarea>

    <textarea id="input" style="visibility: hidden; width: 0vw; height: 0vh;"></textarea>
</body>
<script>

    function emscripten_sleep(ms) {
        Asyncify.handleSleep(function (wakeUp) {
            setTimeout(wakeUp, ms);
        });
    }

    let x = null;

    function read(success) {
        x = success;

    };



    document.addEventListener('keyup', (e) => {
        e = e || window.event;

        

        if (e.keyCode == 13 && $("#input").val().length > 0) {
            x($("#input").val());
            $("#input").val("");
                $("#output").val($("#output").val() + "\n");
            return false;
        }
        else if (e.key == "Backspace")
        {
            
            $("#input").val($("#input").val().substring(0, $("#input").val().length - 1));
            $("#output").val($("#output").val().substring(0, $("#output").val().length - 1));
        }
        else
        {
            if (e.key.length == 1)
            {
                $("#input").val($("#input").val() + e.key);
                $("#output").val($("#output").val() + e.key);
            }
        }
        return true;
    }, false);

    var re = /^___terminal::/;
    // XHR proxy that handle methods from fetch in C
    window.XMLHttpRequest = (function (xhr) {
        return function () {
            var url;
            var props = {
                readyState: 4,
                status: 200
            };
            var enc = new TextEncoder("utf-8");
            return new Proxy(new xhr(), {
                get: function (target, name) {
                    if (url && ['response', 'responseText', 'status', 'readyState'].indexOf(name) != -1) {
                        if (name == 'response') {
                            var response = enc.encode(props.responseText);
                            return response;
                        }
                        return props[name];
                    } else if (name == 'open') {
                        return function (method, open_url) {
                            if (open_url.match(re)) {
                                url = open_url;
                            } else {
                                return target[name].apply(target, arguments);
                            }
                        };
                    } else if (name == 'send') {
                        return function (data) {
                            if (url) {
                                var payload = url.split('::');
                                if (payload[1] == 'read') {
                                    $("#output").val($("#output").val() + "> ");
                                    read(
                                        function (text) {
                                            props.responseText = text + '\0';
                                            target.onload();
                                        }
                                    );
                                }

                            } else {
                                return target[name].apply(target, arguments);
                            }
                        };
                    }
                    return target[name];
                },
                set: function (target, name, value) {
                    target[name] = value;
                }
            });
        };
    })(window.XMLHttpRequest);
    // below code modified from emscripten output html
    var Module = {
        preRun: [],
        postRun: [],
        print: function (text) {
            $("#output").val($("#output").val() + text + "\n");
            document.getElementById("output").scrollTop = document.getElementById("output").scrollHeight 

        },
        printErr: function (text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            console.log(text);
        },
        canvas: (function () {
            var canvas = document.createElement('canvas');

            // As a default initial behavior, pop up an alert when webgl context is lost. To make your
            // application robust, you may want to override this behavior before shipping!
            // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
            canvas.addEventListener("webglcontextlost", function (e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

            return canvas;
        })(),
        setStatus: function (text) {
        },
        totalDependencies: 0,
        monitorRunDependencies: function (left) {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
    };
    Module.setStatus('Downloading...');
    window.onerror = function (event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function (text) {
            if (text) Module.printErr('[post-exception status] ' + text);
        };
    };
</script>
<script async type="text/javascript" src="main.js"></script>

</html>